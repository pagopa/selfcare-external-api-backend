meta {
  name: createDelegationFromTaxCode
  type: http
  seq: 1
}

post {
  url: {{apiBaseUrl}}/external/internal/v1/delegations/from-taxcode
  body: json
  auth: inherit
}

headers {
  Ocp-Apim-Subscription-Key: {{apimKeyInternal}}
  Content-Type: application/json
}

body:json {
  {
    "fromTaxCode": "{{fromTaxCode}}",
    "toTaxCode": "{{toTaxCode}}",
    "institutionFromName": "Test Institution From",
    "institutionToName": "Test Institution To",
    "productId": "{{productId}}",
    "type": "EA"
  }
}

script:post-response {
  test("createDelegationFromTaxCode ok", function() {
    const status = res.getStatus();
    expect([201, 409]).to.include(status);

    const jsonData = res.getBody();

    if (status === 201) {
      expect(jsonData).to.have.property("id").that.is.a("string");
      expect(jsonData).to.have.property("institutionId").that.is.a("string");
      expect(jsonData).to.have.property("institutionName").that.is.a("string");
      expect(jsonData).to.have.property("productId").that.is.a("string");
      expect(jsonData).to.have.property("brokerId").that.is.a("string");
      expect(jsonData).to.have.property("type", "EA");
    } else if (status === 409) {
      expect(jsonData).to.have.property("status", 409);
      expect(jsonData).to.have.property("title", "Conflict");
    }
  });
}

settings {
  encodeUrl: true
}
